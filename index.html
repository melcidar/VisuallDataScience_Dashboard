<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gender Gaps in Education per World Bank Regions</title>

  <!-- Vega libraries -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }
    h1 {
      text-align: center;
    }
    .controls {
      text-align: center;
      margin-bottom: 20px;
    }
    #chart, #map {
      max-width: 1000px;
      margin: 40px auto;
    }
  </style>
</head>

<body>

<h1>Gender Gaps in Education per World Bank Regions</h1>

<div class="controls">
  <label for="year">Year:</label>
  <input type="range" id="year" min="1999" max="2020" value="2020">
  <span id="yearValue">2020</span>
</div>

<div class="controls">
  <button onclick="setLevel('primary')">Primary</button>
  <button onclick="setLevel('lower_secondary')">Lower Secondary</button>
  <button onclick="setLevel('upper_secondary')">Upper Secondary</button>
  <button onclick="setLevel('tertiary')">Tertiary</button>
</div>

<div class="controls">
  <button onclick="setRegion(null)">All regions</button>
  <button onclick="setRegion('Europe and Central Asia (WB)')">Europe & Central Asia</button>
  <button onclick="setRegion('East Asia and Pacific (WB)')">East Asia & Pacific</button>
  <button onclick="setRegion('Latin America and Caribbean (WB)')">Latin America & Caribbean</button>
  <button onclick="setRegion('Middle East and North Africa (WB)')">MENA</button>
  <button onclick="setRegion('North America (WB)')">North America</button>
  <button onclick="setRegion('South Asia (WB)')">South Asia</button>
  <button onclick="setRegion('Sub-Saharan Africa (WB)')">Sub-Saharan Africa</button>
</div>

<div id="chart"></div>
<div id="map"></div>

<script>
const yearSlider = document.getElementById("year");
const yearValue = document.getElementById("yearValue");

let selectedLevel = "primary";
let selectedRegion = null;

/* ================= BAR CHART ================= */

function renderChart(year) {

  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "data": { "url": "data.json" },
    "transform": [
      { "filter": `datum.year == ${year}` },
      { "filter": `datum.level == '${selectedLevel}'` }
    ],
    "mark": "bar",
    "encoding": {
      "x": {
        "field": "region",
        "type": "nominal",
        "axis": { "labelAngle": -40 },
        "title": "World Bank Region"
      },
      "y": {
        "field": "gender_gap",
        "type": "quantitative",
        "title": "Gender gap (female − male)"
      },
      "color": selectedRegion
        ? {
            "condition": {
              "test": `datum.region == '${selectedRegion}'`,
              "value": "#1f77b4"
            },
            "value": "#d3d3d3"
          }
        : {
            "field": "region",
            "type": "nominal",
            "legend": null
          },
      "opacity": selectedRegion
        ? {
            "condition": {
              "test": `datum.region == '${selectedRegion}'`,
              "value": 1
            },
            "value": 0.3
          }
        : { "value": 1 }
    }
  };

  vegaEmbed("#chart", spec, { actions: false });
}

/* ================= WORLD MAP ================= */

function renderMap(year) {

  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",

    "data": {
      "url": "https://vega.github.io/vega-datasets/data/world-110m.json",
      "format": { "type": "topojson", "feature": "countries" }
    },

    "transform": [
      /* normalize country name */
      {
        "calculate": "replace(datum.properties.name, 'United States of America', 'United States')",
        "as": "country"
      },

      /* country -> WB region */
      {
        "lookup": "country",
        "from": {
          "data": { "url": "country_to_wb_region_array.json" },
          "key": "country",
          "fields": ["region"]
        }
      },

      /* attach education data */
      {
        "lookup": "region",
        "from": {
          "data": { "url": "data.json" },
          "key": "region",
          "fields": ["gender_gap", "year", "level"]
        }
      },

      /* filter year & level */
      { "filter": `datum.year == ${year}` },
      { "filter": `datum.level == '${selectedLevel}'` },

      /* aggregate by region */
      {
        "aggregate": [
          { "op": "mean", "field": "gender_gap", "as": "gender_gap" }
        ],
        "groupby": ["region", "properties.name"]
      }
    ],

    "projection": { "type": "equalEarth" },

    "mark": { "type": "geoshape", "stroke": "white" },

    "encoding": {
      "color": {
        "field": "gender_gap",
        "type": "quantitative",
        "scale": {
          "scheme": "redblue",
          "reverse": true
        },
        "title": "Gender gap (female − male)"
      },
      "tooltip": [
        { "field": "properties.name", "title": "Country" },
        { "field": "region", "title": "WB Region" },
        { "field": "gender_gap", "title": "Gender gap", "format": ".2f" }
      ]
    }
  };

  vegaEmbed("#map", spec, { actions: false });
}


/* ================= INTERACTION ================= */

yearSlider.addEventListener("input", () => {
  yearValue.textContent = yearSlider.value;
  renderChart(yearSlider.value);
  renderMap(yearSlider.value);
});

function setLevel(level) {
  selectedLevel = level;
  renderChart(yearSlider.value);
  renderMap(yearSlider.value);
}

function setRegion(region) {
  selectedRegion = region;
  renderChart(yearSlider.value);
  renderMap(yearSlider.value);
}

/* ================= INITIAL RENDER ================= */

renderChart(2020);
renderMap(2020);
</script>

</body>
</html>
